__README__
==========

Данное финансовое приложение представляет собой набор приложений с возможностями регистрации пользователей, открытия и 
закрытия счетов, их пополнения и обналичивания, сервисами перевода денег между своими счетами, и на счета других 
пользователей, а также виджетом с обновляющимися курсами валют.

Использованный стек: Java SE 21, Spring Boot, Spring Security, JPA, PostgreSQL, Spring Retry, Keycloak, REST, Gradle, Lombok,
Thymeleaf, JUnit 5, Mockito, Kafka, Docker, Kubernetes, Jenkins, Helm.

Установка и запуск:
-----------------------------------

**1.** Склонируйте репозиторий.

**2.** На устройстве должны быть установлены Docker, Kubernetes и Helm. 

**3.1** Для автоматического развертывания приложения с помощью Jenkins, нужно установить и запустить Jenkins 
(директория ```jenkins``` в репозитории). Для этого нужно заполнить файл ```.env``` и файл конфигурации для подключения 
Jenkins к Kubernetes (файл```config``` в директории ```jenkins/config``` ). Затем нужно запустить  ```docker-compose.yml``` в
директории ```jenkins```. Jenkins будет доступен по адресу: ``` http://localhost:8080 ```  и автоматически запустит 
CI/CD-пайплайн.

**3.2** Для ручной установки нужно:

- Запустить сборку приложения с помощью IDE или в корневой директории репозитория командой:  ```gradlew.bat build```.

- Запустить сборку образов в корневой директории репозитория командами:
```
    docker build -t accountservice:latest ./accountservice
    docker build -t blockerservice:latest ./blockerservice
    docker build -t cashservice:latest ./cashservice    
    docker build -t exchangeservice:latest ./exchangeservice
    docker build -t exchangegeneratorservice:latest ./exchangegeneratorservice
    docker build -t frontservice:latest ./frontservice   
    docker build -t notificationservice:latest ./notificationservice
    docker build -t transferservice:latest ./transferservice
```

- Запустить приложение в Kubernetes в корневой директории репозитория командой ```helm dependency update ./bankapp``` и  
затем командой ```helm install bankapp ./bankapp```.

**4.** Приложение будет доступно по адресу: ```http://bankapp.local```

Для этого в Kubernetes должен быть установлен Ingress-контроллер 
(```kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml``` ), 
а в файл ```hosts``` в ```Windows\System32\drivers\etc``` нужно добавить строку ```127.0.0.1 bankapp.local```.

Также можно запустить команду ```kubectl port-forward svc/bankapp-frontservice 8888:8888```, тогда приложение будет 
доступно на ``` http://localhost:8888 ```


Функционал приложения:
------------------------------------------

**Регистрация приложении**

``` http://bankapp.local ``` автоматически перенаправляет на ``` http://bankapp.local/login ```. На этой странице 
нужно нажать на кнопку "Регистрация", чтобы перейти на ``` http://bankapp.local/signup ```. На этой странице 
нужно заполнить форму и отправить форму с данными (логин, имя, пароль, дата рождения, email). 

Регистрация невозможна, если уже есть пользователь с таким логином или email, если пользователю нет 18 лет, 
если пароль не совпадает, если указан email неправильного формата. В таком случае будет выдано сообщение об ошибке. 

В случае успешной регистрации сработает перенаправление на ``` http://bankapp.local/login ```.

**Авторизация в приложении**

На странице ``` http://bankapp.local/login ``` нужно заполнить логин и пароль. В случае успешной авторизации 
произойдет перенаправление на ``` http://bankapp.local/main ```. Это страница личного кабинета, доступная только 
авторизированному пользователю. Разлогиниться можно с помощью кнопки "Выйти".

**Редактирование профиля**

Можно поменять пароль в верхнем блоке. Если пароль не совпадает, будет выдано сообщение об ошибке.
Также можно поменять имя, email и дату рождения. Текущие данные  указаны слева от формы. 
В форме нужно заполнить все поля. Требования к email и возрасту здесь также применимы.

**Счета**

Можно открыть счета в следующих валютах - рубль, доллар, юань. Пустой счет можно закрыть. При попытке 
закрыть счет с положительным балансом будет выдано сообщение об ошибке. Открытие/закрытие счетов 
регулируется чекбоксами справа. Можно иметь только 1 счет на 1 валюту.

**Переводы**

Переводы можно делать на другие свои счета и на счета других пользователей. 

Для перевода на другой свой 
счет нужно выбрать оба счета в соответствующих меню, ввести сумму, и нажать на кнопку. Нельзя выбирать 
один и тот же счет в обеих меню.

Для перевода другому пользователю в одном меню нужно выбрать свой счет, а в другом - счет другого пользователя с 
нужной валютой (в каждом пункте пользователь + его счет). В этом меню указываются только счета пользователей, 
имеющиеся в базе приложения.

**Блокирование операций**

В приложении реализовано блокирование переводов, снятия/пополнения счетов по заданным условиям. 
В настоящее время условия - пополнение/снятие больше чем на 500 единиц, перевод больше чем на 
1000 единиц.

**Уведомления**

В приложении реализованы уведомления. После блокирования операции или успешного перевода, 
пользователю придет уведомление на почту. В настоящее время в приложении подключен демонстрационный почтовый 
сервер *Mailhog*.

**Виджет валют**

Внизу страницы ежесекундно обновляются курсы валют.

Структура приложения:
------------------------------------------

Приложение состоит из следующих микросервисов:

1. **Front service** — пользовательский интерфейс.
2. **Account service** с базой данных **accountdb** (Postgresql) — сервис, отвечающий за хранение и изменение данных
 пользователей и данных их счетов; балансы счетов; открытие и закрытие счетов.
3. **Transfer service** - сервис, отвечающий за обработку переводов.
4. **Cash service** - сервис, отвечающий за пополнение/снятие денег.
5. **Exchange service** с базой данных **exchangedb** (Postgresql) - сервис, отвечающий за конвертацию курсов валют 
 между собой, и их хранение.
6. **Exchange generator service** - сервис, отвечающий за генерацию курсов валют. Содержит логику генерации и список
 доступных в приложении валют.
7. **Blocker service** — сервис, отвечающий за блокировку операций. Содержит логику блокирования.
8. **Notification service** с базой данных **notificationdb** (Postgresql) — сервис отправки и хранения уведомлений. Содержит 
 данные подключенного почтового сервиса (сейчас - *Mailhog*).

Микросервисы развернуты в **Kubernetes**-кластере (**Docker** используется в качестве контейнерной среды), безопасность 
 их взаимодействия обеспечивается с помощью сервера **Keycloak**. 
 Взаимодействие Exchange generator service с Exchange service, а также Transfer service, Cash service и 
 Account service с Notification service осуществляется с помощью **Apache Kafka**.

Тесты
------------------------------------------

К приложению прилагаются тесты.